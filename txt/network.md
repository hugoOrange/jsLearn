###一些概念

#### 以太网 互联网 万维网

- 以太网：是一种[计算机](https://zh.wikipedia.org/wiki/%E8%AE%A1%E7%AE%97%E6%9C%BA)[局域网](https://zh.wikipedia.org/wiki/%E5%B1%80%E5%9F%9F%E7%BD%91)**技术**
- 互联网：是[网路](https://zh.wikipedia.org/wiki/%E7%B6%B2%E8%B7%AF)与网路之间所串连成的庞大**网路**，这些网路以一组标准的网路[TCP/IP协议族](https://zh.wikipedia.org/wiki/TCP/IP%E5%8D%8F%E8%AE%AE%E6%97%8F)相连，连接全世界几十亿个设备，形成逻辑上的单一巨大国际网络
- 万维网：是一个由许多互相链接的[超文本](https://zh.wikipedia.org/wiki/%E8%B6%85%E6%96%87%E6%9C%AC)组成的**系统**，通过[互联网](https://zh.wikipedia.org/wiki/%E4%BA%92%E8%81%94%E7%BD%91)访问

也就是说，以太网是一种技术，互联网是一种网络（可能通过以太网实现），万维网是一个系统（可以通过互联网访问）

#### 网络的分类

#### LAN 局域网

常见的形式：以太网（Ethernet），令牌环网（TokenRing）、光钎分布式数据借口（FDDI），异步传输模式（ATM）。

常用的设备：网卡（NIC），集线器（Hub），交换机（Switch），线缆。

#### MAN 域域网

#### WAN 广域网

连接各种局域网而成，结构包含末端系统（两端的网络）和通信系统（中间链路）两部分。与局域网相比，通常需要付费。

主要看通信系统：公共电话网（PSTN），综合业务数字网（ISDN），专线（Leased Line，中国叫DDN），X.25网，帧中继，异步传输模式（ATM）。

常用设备：路由器（Router），调制解调器（Modem）。

#### 为什么常常说TCP/IP，而不是分开说

这表示一个协议族（IPS），常被视为简化的七层OSI模型。

另外，TCP模块处理数据时会用到IP模块的头部（接收方IP等等），虽然基于职责而言，TCP不应该这样做，但是其实TCP和IP之间的交互要更加频繁，为减少成本才这样做。

#### 各层的对应关系

- 应用层：HTTP，FTP
- 网络层：IP
- 传输层：TCP， UDP -- 路由器
- 链路层：ARP -- 交换机
- 物理层： -- 集线器


####为什么光钎通信速率更快

因为光信号的信号衰减少。




### IP的含义

####IP省略的规则：

- 对于http://sample.com/，把其当成根目录处理，访问默认的文件（一般是index.html），同理，http://sample.com/apple/也一样
- 对于http://sample.com/apple，先找目录下的`apple`文件，然后把其当做目录处理

IP地址的前三部分表示网络号，最后一个8比特表示主机号

IP地址的主机号全为0表示整个子网，全为1表示向子网所有设备发送包（广播）

```
255.255.255.0 // 表示整个子网
255.255.255.1 // 表示向子网所有设备发送包
```

####子网掩码的表示方式

以下两者等同（后面的均表示子网掩码）：

```
193.168.1.3/24
193.168.1.3/255.255.255.0
```



### 网关

转发其他服务器通信数据的服务器。

在传统TCP/IP术语中，网络设备只分为两种：**网关(gateway)**，**主机(host)**。其中，后者不能转发数据。

与路由器的区别，网关能在不同协议间移动数据，路由器是在不同网络间移动数据。



### 客户端和服务器连接（HTTP+TCP部分）

#### 步骤

1. 根据（调用操作系统的Socket库）域名查询IP地址
2. 创建套接字(socket)
3. 使用套接字与服务器建立连接(connect)
4. 数据（包括HTTP头部）分割成包，加TCP头部
5. 收发消息，进行数据交互
6. 服务器或客户端断开连接并删除套接字

####域名

域名使用`.`来分隔，越靠右的域名层级越高。

DNS客户端查询IP地址的过程：先查最近的DNS服务器，如果没有，查查根域的有没有，再逐层往下。

例：查询www.lab.glassroom.com的ip：

Socket库询问最近的DNS服务器 -> （DNS，以下省略）服务器不知道，服务器去查根域有没有 -> 服务器询问根域（DNS服务器，以下省略） -> 根域不知道，返回它下面com域 -> 服务器询问com域 -> com域不知道，返回它下面glassroom域 -> ... -> 服务器询问lab域 -> lab域知道，返回给服务器IP地址 -> 服务器返回给客户端域名的IP地址

DNS服务器缓存：保存的信息都有个期限，并且也能从响应中得知信息是来自缓存还是包含该域名的DNS服务器。

#### 套接字

套接字是没有实体的，每一个设备（如网卡）一个IP。

####套接字描述符与端口号的区别

服务器在启动之后监听对应的端口号，当接收到相应的端口号的时候就会启动程序进行响应。同时，为了能够处理来自多个客户端的请求，服务器在处理信息之前还会复制一份套接字的副本来接收其他客户端的请求。这样就无法通过端口号来识别与不同客户端建立的套接字，就只能通过描述符加以识别。那，怎么识别是来自不同客户端的请求呢？通过双方的IP进行识别。

也就是，通过描述符识别本机上的不同连接，或来自不同客户端的同一请求，通过端口号识别不同的请求（可能同一客户端）。

#### 连接包括哪些具体操作

告诉操作系统协议栈服务器的IP地址和端口号信息，告知服务器IP地址和端口号信息。

详细：创建一个包含开始收发信息的控制信息头部(SYN = 1)，发送到服务器；成功则响应(SYN = 1 && ACK = 1)，若失败则响应(RST = 1)，至此则成功连接（即Socket库中的`connect`操作完成。

#### MTU MSS

前者表示`IP头部 + TCP头部 + 数据`的最大可传输值，后者表示`数据`的最大可传输值

#### TCP分割包

TCP头部字段：发送方端口号、接收方端口号、序号、ACK、数据偏移量、保留、控制位（包括ACK RST SYN FIN）、窗口、校验和、紧急指针、可选字段。

#####序号和ACK

每次收发数据时，发送方发送序号（如1）和长度（如1500），接收方回送ACK号（1501)进行确认，然后发送方再进行数据发送（序号1502、长度1500）。TCP就是以这种方式确认接收方是否接受数据。

PS:出于安全考虑，序号不一定从1开始。第一次序号发送在请求连接的时候（发送SYN=1），无论是客户端还是服务器。

##### 滑动窗口方式 窗口

接收方有一个缓冲区用来接收数据，使得发送方能够连续的发送数据而不用等待接收方处理完数据（如下图）。

这也意味着缓冲区溢出就不能接收数据了，这里的窗口就是表示缓冲区剩余的空间大小。

![](../img/tcpSend.png)

#### 关闭连接

以下简称主动发起方为A，另一方为B。

A结束数据收发操作（等待一段时间后删除套接字） -> A发送FIN:1 -> B接收并发送ACK号 -> B结束数据收发操作 -> B发送FIN:1 -> A接收ACK号 -> 等待一段时间删除套接字（防止误操）

#### TCP UDP

TCP是为了可靠性而使用的，因此，当数据足够小能装进一个包里的时候就会使用UDP。有时候考虑到实时性也会使用UDP。



### IP协议对包的操作

####IP模块对各种类型的包收发操作都一样

####IP头部

版本号、头部长度(IHL)、服务类型(ToS)、总长度、ID号、标志(Flag)、分片偏移量、生存时间(TTL)、协议号、头部校验和、发送方IP、接收方IP、可选字段。

ID号用来区分包，同一包的不同分片ID号相同。

生存时间用来防止包被循环传输，每经过一个路由器会减1，为0时抛弃。

#### MAC头部 IP头部

前者存储下一跳的IP，后者存储目的IP。

前者不断变化，后者保持不变。

前者由制造商分配，后者基于网络拓扑。

#### MAC地址或IP地址存在的必要性

MAC地址是唯一的，IP地址是动态分配的。

若只有MAC地址，也就是DNS服务器返回的是MAC地址，则因为MAC地址之间没有关联性，根据MAC地址寻址服务器就变得很困难，速度很慢。

若只有IP地址，因为IP是动态变化的，所以路由器需要实时更新路由表。

####根据IP查询MAC的机制叫ARP

#### IPv4 IPv6

后者是因为IP4的地址容量不足而诞生的。

IPv6的优势

- 明显扩大地址空间，IPv6采用128位地址长度
- 提高网络整体吞吐量，因为IPv6数据包可以远远超过64k字节
- 改善服务
- 保障安全性
- 支持即插即用和移动性



### MAC协议对包的操作

网卡的MAC模块生成通用信号，然后由PHY（MAU）模块转换成可在网络中传输的格式，由网线发送出去。

#### 数据变更

`报头和起始帧的分界符 + MAC头部 + IP头部 + TCP头部 + 数据 + FCS`

报头和起始帧的分界符是用来确定波形的变化情况（当波形出现连续的1或0时无法进行准确的测量，需要结合时钟信号修正）。

FCS是用来校验的。

#### MAC模块做的事情

这是在网卡中的一个模块。

对服务器而言，先将电信号或光信号转换成数字信号（即把信号从叠加的信号中抽出来）；检查FCS，是否失真；若FCS一致，则检查接收方MAC地址，看是不是发送给自己的，如果不是就丢弃，是就存入缓冲区。

#### 路由器 交换机 集线器

- 路由器

  - 特点
    - 通过查表判断目标
    - 具备多种保护机制：如抑制广播风暴，增加网络安全性，使管理控制集中
    - 有防火墙
    - 成本高
  - 使用场景：将多个内网互接形成一个VLAN（虚拟局域网）
  - OSI层级：网络层

- 交换机

  - 特点

    - 通过查表判断目标

    - 能够接入很多台设备
    - 独享带宽
    - 全双工
    - 容易碰撞、阻塞 
    - 只进行转发，自身不会成为发送方或接收方

  - 使用场景：内网机器互接形成一个较大的局域网

  - OSI层级：链路层

- 集线器

  - 特点
    - 对已经衰弱的信号进行加强
    - 通过广播传递信息
    - 共享带宽
    - 半双工
    - 容易碰撞、阻塞
  - 使用场景：远距离信号端对端传输
  - OSI层级：物理层

综合来讲，在底层用集线器加强信号，然后组织（如公司、办公室）内部使用交换机连接成一个局域网，通过一个路由器对外接入。

路由器是基于IP设计的，交换机是基于以太网设计的。

路由器有些也具有交换机功能，交换机的一个端口也可能是集线器；

“纯粹”的路由器没有数据传输功能，而是委托以太网（交换机或集线器）进行传输。



### 路由器

也有MAC号，也会进行分片

####路由器忽略主机号，匹配网络号

#### 路由表

- 目标地址
- 子网掩码：在路由聚合后，表示处于哪一个子网之下；表示在匹配网络包目标地址时需要对比的比特数量
- 网关：
- 接口
- 跃点数：越大表示距离目标路由越远

#### 判断下一跳地址

- 如果路由器网关列为IP地址，则该地址就是下一跳地址
- 如果路由器网关列为空，则IP头部中的接收方地址就是下一跳地址

####路由选择

1. 匹配网络号得到候选可用的IP
2. 根据**最长匹配原则**，选出子网掩码最大的那个
3. 没有选出则选出跃点数最少的那个
4. 选默认路由（子网掩码为0.0.0.0的目标地址）

eg：假设有这么一个路由表，包目标地址为193.168.1.5

| 目标地址      | 子网掩码        | 跃点数 |
| ------------- | --------------- | ------ |
| 192.168.1.103 | 255.255.255.255 | 2      |
| 192.168.1.0   | 255.255.255.0   | 1      |
| 192.168.1.20  | 255.255.255.255 | 1      |
| 192.160.1.103 | 255.255.255.0   | 1      |

首先根据第1点，可知第4项不合；

然后根据第2点，可选出第1个和第3个；

最后根据第3点，可选出是第3个。

####路由器主动丢弃包的情况路由器

- 对于与自身地址不匹配的包直接丢弃
- 包无法分片丢弃（情况少见）
- 生命周期（TTL，每过一个路由减少1）为0丢弃

#### 路由分配

由于IP地址是有限的，所以为了重用IP，进行地址转换。在IP地址中，将下列这些地址作为私有地址：

- 10.0.0.0 ~ 10.255.255.255
- 172.16.0.0 ~ 173.31.255.255
- 192.168.0.0 ~ 192.168.255.255


这些地址在不同的局域网可重复。

然后组织通过对外接入一个路由器进行地址转换（将内部不同的私有地址映射成相同的公有地址和不同端口号），如下：

| 公有地址    | 端口号 | 私有地址  | 端口号 |
| ----------- | ------ | --------- | ------ |
| 198.18.8.31 | 5436   | 10.10.1.1 | 1025   |
| 198.18.8.31 | 5437   | 10.10.1.2 | 1025   |
| 198.18.8.31 | 5438   | 10.10.1.3 | 2583   |

当组织内部向外网访问时就会经过一个地址转换，有私有地址映射成公有地址。

所以要从封闭的组织内部访问外网，则往地址转换表加上相应的规则就可以了。



### 通过接入网连入互联网

####术语解释

BAS：宽带接入服务器，是一种路由器

Modem：调制解调器

RAS：远程访问服务，是软件或硬件的组合

####具体过程

- 接入结构：用户 --接-- 最近电话局（通过BAS） --隧道-- 运营商电话局 --接-- 路由器、互联网
- 接入方式：ASDL方式（电话线）和FTTH方式（光纤）
  - 准备阶段：在接入路由器中配置运营商分配的用户名、密码，然后，接入路由器根据PPPoE的机制寻找BAS，获得其MAC地址
  - 进行连接：
    - 通过Modem和连接线路与RAS相连
    - 通过LCP交换网络信息
    - 用户验证
    - 下发TCP/IP配置信息（如分配IP）
    - 。。。（成功连接）
    - 收发数据包




### 防火墙的原理

现在主流的防火墙是用包过滤实现的，通过限制发送方或接收方的地址、端口号，或TCP头部的字段，来阻止某些特定的包流入或流出。



### 代理（服务器）

####（正向）代理

在客户端，多个客户端可能与一个代理连接，接收客户端的请求后转发给其他服务器。

服务器不知道真实的客户端IP，只知道访问的代理IP地址。

功能如下：

- 提高访问速度，如缓存服务器，CDN
- 控制对内部资源的访问，如大学里的VPN
- 过滤内容，如防火墙
- 隐藏真实IP，免受攻击
- 突破自身IP的访问限制，如中国翻墙
- 突破内容过滤机制，访问被过滤网站

#### 反向代理

在服务器端，服务器根据客户端的请求，从一组或多组后端服务器上获取资源，然后再将这些资源返回给客户端。

客户端只知道反向代理的IP地址，而不知道代理后面的服务器簇。

功能如下：

- 对客户端隐藏服务器地址
- 安全，为应用层做防火墙
- 同一提供加密和SSL加速
- 负载均衡
- 缓存服务器
- 压缩内容，节约带宽
- 减速上传
- 为私有网络提供NAT穿透及外网发布服务，就像公司内网访问外网一样
- 提供HTTP访问认证
- 突破互联网封锁

####透明代理

在客户端，但是会告诉服务器客户端的真实IP。



###数据的变化

- 应用程序数据
- HTTP协议：HTTP头部 + 应用程序数据 （包）
- TCP协议：TCP头部 + 分割成片段的包
- IP协议：MAC头部 + IP头部 + TCP头部 + 分割成片段的包

